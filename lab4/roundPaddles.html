<!DOCTYPE html>

<html>

<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>

<head>
  <meta charset="UTF-8">
  <title>Canvas</title>
  <h1>Ivona Cvija</h1>

  <style type="text/css">
    body {
      background-color: white;
    }

    /*add border of canvas*/
    canvas {
      border: black 3px solid;
    }
  </style>

</head>

<body>

  <div id="collisionMessage"></div>

  <canvas id="canvas-for-ball" width="400" height="400"></canvas>

  <script type="text/javascript">

    window.addEventListener("keydown", function (event) {
      console.log(event);
    });
    //create class Ball
    class Ball {
      //create constructor
      constructor(x, y, r, xSpeed, ySpeed, angle, rotationSpeed) {
        this.x = x;
        this.y = y;
        this.r = r;
        this.xSpeed = xSpeed;
        this.ySpeed = ySpeed;
        this.angle = angle;
        this.rotationSpeed = rotationSpeed;
      }
      //draw method for creating the ball
      draw() {

        //draw the ball
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
        ctx.stroke();
      }
      drawRotateX() {
        //drawing the X
        var point1 = Math.PI / 4;
        var point2 = 5 * (Math.PI) / 4;
        var point3 = 7 * (Math.PI) / 4;
        var point4 = 3 * (Math.PI) / 4;
        //rotationg the x
        this.angle = this.angle + this.rotationSpeed;

        ctx.moveTo(Math.cos(point1 + this.angle) * this.r + this.x, Math.sin(point1 + this.angle) * this.r + this.y);
        ctx.lineTo(Math.cos(point2 + this.angle) * this.r + this.x, Math.sin(point2 + this.angle) * this.r + this.y);
        ctx.stroke();

        ctx.moveTo(Math.cos(point3 + this.angle) * this.r + this.x, Math.sin(point3 + this.angle) * this.r + this.y);
        ctx.lineTo(Math.cos(point4 + this.angle) * this.r + this.x, Math.sin(point4 + this.angle) * this.r + this.y);
        ctx.stroke();
      }
      //move method for moving the ball
      move() {
        //change x and y to move the ball.
        this.y += this.ySpeed;
        this.x += this.xSpeed;

        //bottom wall, gravity
        // if (this.y >= 400 - this.r) {
        //   this.y = 400 - this.r;
        //   console.log("PING The ball hit the bottom edge");
        //   this.ySpeed = this.ySpeed * -0.9;
        // }
      }
      gravityPull() {
        this.ySpeed += 0.1;
      }
      changeRotationDirection() {
        //change direction of the rotation when the ball reaches the edge
        if (this.y >= 400 - this.r) {
          console.log("PING The ball hit the bottom edge");
          this.angle = this.angle * -1;
          this.rotationSpeed = this.rotationSpeed * -1;
        }
        if (this.y <= this.r) {
          console.log("PONG The ball hit the top edge");
          this.angle = this.angle * -1;
          this.rotationSpeed = this.rotationSpeed * -1;
        }
        if (this.x >= 400 - this.r) {
          console.log("PONG The ball hit the right edge");
          this.angle = this.angle * -1;
          this.rotationSpeed = this.rotationSpeed * -1;
        }
        if (this.x <= this.r) {
          console.log("PONG The ball hit the left edge");
          this.angle = this.angle * -1;
          this.rotationSpeed = this.rotationSpeed * -1;
        }
      }
      changeDirection() {
        //change direction when the ball reaches the edge
        if (this.y >= 400 - this.r) {
          console.log("PING The ball hit the bottom edge");
          this.ySpeed = this.ySpeed * - 1;
        }
        if (this.y <= this.r) {
          console.log("PONG The ball hit the top edge");
          this.ySpeed = this.ySpeed * - 1;
        }
        if (this.x >= 400 - this.r) {
          console.log("PONG The ball hit the right edge");
          this.xSpeed = this.xSpeed * - 1;
        }
        if (this.x <= this.r) {
          console.log("PONG The ball hit the left edge");
          this.xSpeed = this.xSpeed * - 1;
        }
      }
      //collision detection method
      collisionDetection() {
        //distance between the ball and the left paddle
        const disXLP = this.x - p1.x;
        // console.log("b1 x: "+ b1.x);
        // console.log("p1 x: "+ p1.x);
        // console.log("disXLP: "+ disXLP);
        const disYLP = this.y - p1.y;
        //calculate euclidean distance
        const currentDistanceLP = Math.sqrt(disXLP * disXLP + disYLP * disYLP);
        //distance between the ball and the right paddle
        const disXRP = this.x - p2.x;
        const disYRP = this.y - p2.y;
        //calculate euclidean distance
        const currentDistanceRP = Math.sqrt(disXRP * disXRP + disYRP * disYRP);

        if (currentDistanceLP <= this.r + p1.r) {
          console.log('Collision detected, left paddle');
          this.xSpeed = this.xSpeed * - 1;

          // Show the text "Collision detected, left paddle" in an HTML element with the ID "collisionMessage" for 750 milliseconds
          const msgElement = document.getElementById("collisionMessage");
          msgElement.innerHTML = "Collision detected, left paddle";

          setTimeout(function () {
            msgElement.innerHTML = ''; // Clear the message after 750 milliseconds
          }, 750);


          // //show text for 0.75 seconds
          // document.getElementById("Collision detected, left paddle").innerHTML = msg;
          // setTimeout(function () {
          //   document.getElementById("Collision detected, left paddle").innerHTML = '';
          // }, 750);


          // let showTextUntil = performance.now() + 750; // 750 milliseconds = 0.75 sec
          // function renderText() {
          //   ctx.font = "30px Arial";
          //   ctx.fillText("Collision detected", 10, 50);
          //   if (performance.now() < showTextUntil) {
          //     requestAnimationFrame(renderText);
          //   }
          // }
          // requestAnimationFrame(renderText);
        }
        else if (currentDistanceRP <= this.r + p2.r) {
          console.log('Collision detected, right paddle');
          this.xSpeed = this.xSpeed * - 1;
        }
      }
    }
    //create class Paddle
    class Paddle {
      //create constructor
      constructor(x, y, r, red, green, blue) {
        this.x = x;
        this.y = y;
        this.r = r;
        this.red = red;
        this.green = green;
        this.blue = blue;
      }
      //draw method for creating the paddle
      draw() {
        //clear the entire canvas
        ctx.clearRect(this.x, this.y, this.width, this.height);
        //draw the rectangle
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
        ctx.stroke();
        //coloring the paddle
        if (this.red == 255) {
          ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
        }
        if (this.green == 255) {
          ctx.fillStyle = "rgba(0, 255, 0, 0.8)";
        }
        if (this.blue == 255) {
          ctx.fillStyle = "rgba(0, 0, 255, 0.8)";
        }
        // Set the canvas up for drawing in 2D.
        ctx.fill();
      }
    }
    //adding objects
    b1 = new Ball(40, 30, 10, 1, 1.5, 0.1, 0.05);
    b2 = new Ball(50, 30, 15, 1, 1, 0.1, 0.1);
    b3 = new Ball(60, 30, 20, 1, 1, 0.1, 0.15);
    p1 = new Paddle(20, 20, 15, 255, 0, 0);
    p2 = new Paddle(365, 20, 15, 0, 0, 255)
    //moving paddles using keyboard
    $(document.body).on('keydown', function (e) {
      console.log(e.which);
      //p1 - up arrow
      if (e.which == 38) {
        console.log('P1 UP!');
        p1.y -= 10;
      }
      //p1 - down arrow
      if (e.which == 40) {
        console.log('P1 DOWN!');
        p1.y += 10;
      }
      //p2 - (with 'W')
      if (e.which == 87) {
        console.log('P2 UP!');
        p2.y -= 10;
      }
      //p2 - (with 'S')
      if (e.which == 83) {
        console.log('P2 DOWN!');
        p2.y += 10;
      }
      //increase the speed of rotation(with '+')
      if (e.which == 107) {
        console.log('FASTER SPIN!');
        b1.rotationSpeed += 0.001;
      }
      //decrease the speed of rotation(with '-')
      if (e.which == 109 && b1.rotationSpeed > 0) {
        console.log('SLOW DOWN, YOU HELICOPTER!');
        b1.rotationSpeed -= 0.001;
      }
      //increase the ball's speed(with '2')
      if (e.which == 50 && b1.xSpeed > 0 && b1.ySpeed > 0) {
        console.log("LET'S GOOO!");
        b1.xSpeed += 1;
        b1.ySpeed += 1;
      }
      //decrease the ball's speed(with '1')
      if (e.which == 49 && b1.xSpeed > 0 && b1.ySpeed > 0) {
        console.log('SLOW NOW!');
        b1.xSpeed -= 1;
        b1.ySpeed -= 1;
      }
    });

    // Gets a handle to the element with id canvasOne.
    var canvas = document.getElementById("canvas-for-ball");
    // Get a 2D context for the canvas.
    var ctx = canvas.getContext("2d");

    // Mouse controlling p1
    var canvasPosition = {
      y: canvas.offsetTop,
      x: canvas.offsetLeft
    }

    canvas.addEventListener("mousemove", function (event) {
      var mouse = {
        x: event.clientX - canvasPosition.x,
        y: event.clientY - canvasPosition.y
      }
      p1.y = mouse.y - (p1.r / 2);
    });

    // A function to repeat every time the animation loops.
    function repeatme() {
      //clear the entire canvas
      ctx.clearRect(0, 0, 400, 400);
      //calling Ball functions
      //draw the ball
      b1.draw();
      b2.draw();
      b3.draw();
      //draw and rotate the X inside the ball
      b1.drawRotateX();
      b2.drawRotateX();
      b3.drawRotateX();
      //move the ball
      b1.move();
      b2.move();
      b3.move();
      //b1.gravityPull();
      //change direction of the rotation of the X
      b1.changeRotationDirection();
      b2.changeRotationDirection();
      b3.changeRotationDirection();
      //change the direction of the ball's movement
      b1.changeDirection();
      b2.changeDirection();
      b3.changeDirection();
      //calling Paddle functions
      //drawing the paddles
      p1.draw();
      p2.draw();
      //collision detection
      // p1.collisionDetection();
      b1.collisionDetection();
      b2.collisionDetection();
      b3.collisionDetection();

      window.requestAnimationFrame(repeatme);
    }

    // Get the animation going.
    repeatme();
  </script>

</body>

</html>